import magic
from django import forms


class FiletypeNotAllowed(Exception):
    pass


class FileTooLarge(Exception):
    pass


class SampleSubmission(forms.Form):
    # only 32 bit and 64 bit windows executables for now
    allowed_types = ['PE32 executable', 'PE64 executable']
    # 5mb
    allowed_size = 5000000
    # the name of variables will be their name in the html source
    uploaded_file = forms.FileField(label='Upload PE32/P64 File', allow_empty_file=False)

    def clean(self):
        cleaned_data = super(SampleSubmission, self).clean()

    def clean_uploaded_file(self):
        try:
            uploaded_file = self.cleaned_data.get('uploaded_file')
            if uploaded_file > self.allowed_size:
                raise FileTooLarge
            uploaded_file_contents = uploaded_file.read()
            filetype = magic.from_buffer(uploaded_file_contents)
            print filetype
            for allowed_type in self.allowed_types:
                print allowed_type
                if allowed_type in filetype:
                    break
                else:
                    raise FiletypeNotAllowed
        except FiletypeNotAllowed:
            raise forms.ValidationError('Uploaded file is not an accepted file format')
        except FileTooLarge:
            raise forms.ValidationError('Uploaded file exceeds 5MB file size limit')
        return uploaded_file
